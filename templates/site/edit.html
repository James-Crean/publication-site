{% extends "base.html" %}
{% block title %}edit{% endblock %}
{% block content %}
{% load my_json %}
<form action="" method="post">
    {% csrf_token %}
    <input type="hidden" name="pub_type" value="{{ pub_type }}">
    {{ pub_form }}
    {{ media_form }}
    <div class="panel panel-default">
        <div class="panel-heading"><span class="md-font">Author Details</span></div>
        <table id="author-form" class="table table-bordered">
            <thead>
            <tr>
                <th>Title</th>
                <th>First Name</th>
                <th>Middle Name</th>
                <th>Last Name</th>
                <th>Institution</th>
                <th>Email</th>
                <th>
                    <a id="add_author" class="btn btn-xs btn-info " role="button" title="Add Author">
                        <span class="glyphicon glyphicon-plus"></span>
                    </a>
                </th>
            </tr>
            </thead>
            <tbody>
            {% for form in author_form %}
            <tr class="author">
                {% for field in form.visible_fields %}
                <td>{{field}}</td>
                {% endfor %}
                <td>
                    <a class="btn btn-xs btn-danger author-delete" role="button" title="Delete">
                        <span class="glyphicon glyphicon-trash"></span>
                    </a>
                </td>
                {% for hidden in form.hidden_fields %}
                    {{hidden}}
                {% endfor %}
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {{author_form.management_form}}
    </div>
    <div id="meta-form">
        <span class="meta-form-list col-md-4 well">{{ exp_form }}</span>
        <span class="meta-form-list col-md-4 well">{{ freq_form }}</span>
        <span class="meta-form-list col-md-4 well">{{ model_form }}</span>
        <span class="meta-form-list col-md-4 well">{{ keyword_form }}</span>
        <span class="meta-form-list col-md-6 well">{{ var_form }}</span>
    </div>
    <div class="text-center">
        <button type="submit" class="btn btn-primary">Submit</button>
    </div>
</form>
<script type="text/javascript">
    var ensemble = JSON.parse({{ ensemble_data|my_json|safe }});
    {# example ensemble: [[1,1], [2,5], [3,1]] #}
    {# where 1,2,3 are experiment id's and 1,5,1 are ensemble values #}
    $(document).ready(function(){
    console.log(ensemble);
    $.each($('#id_experiment li label'), function(index, element) {
        newelem = $('<input/>');
        $(newelem).attr('id', 'ensemble_'+index);
        $(newelem).attr('name', 'ensemble');
        if(ensemble.length > 0 && ensemble[0][0] === index+1) {
            $(newelem).val(ensemble[0][1]);
            ensemble.shift(); //treat the array as a queue. [0] is always the next checked element
        }
        $(element).after(newelem);
        });
    });

    $('#add_author').click(function( event ) {
    event.preventDefault();
    cloneMore('div.author:last', 'form');
    });

    $('.author-delete').click(function( event ) {
        event.preventDefault();
        var form = $(event.target).parent().parent('.author');
        var total = $('#id_form-TOTAL_FORMS').val();
        $('#id_form-TOTAL_FORMS').val(total-1);

        $(form).remove();
    });


</script>
<script type="text/javascript" src="/static/js/authorform.js"></script>
<link href="/static/css/new_publication.css" rel="stylesheet">
{% endblock %}